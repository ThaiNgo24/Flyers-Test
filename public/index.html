<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cambridge Flyers Speaking Test</title>
    <style>
      :root {
        --primary: #0066cc;
        --secondary: #00cc99;
        --accent: #ff6600;
        --light: #f5f9ff;
        --dark: #2d3748;
        --success: #28a745;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f0f4f8;
        color: var(--dark);
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .header h1 {
        color: var(--primary);
        margin-bottom: 10px;
      }

      .header img {
        height: 60px;
        margin-bottom: 15px;
      }

      .student-info {
        margin-bottom: 25px;
        padding: 15px;
        background: var(--light);
        border-radius: 8px;
      }

      .student-info input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      .test-part {
        display: none;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .test-part.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .part-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .part-title {
        font-size: 1.3rem;
        color: var(--primary);
      }

      .part-number {
        background: var(--primary);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .timer {
        background: var(--accent);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: bold;
      }

      .part-image {
        width: 100%;
        max-height: 300px;
        object-fit: contain;
        border-radius: 6px;
        margin: 15px 0;
        border: 1px solid #eee;
      }

      .task-description {
        margin-bottom: 20px;
        font-size: 1.1rem;
        color: var(--dark);
      }

      .controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-record {
        background: var(--accent);
        color: white;
      }

      .btn-stop {
        background: #dc3545;
        color: white;
      }

      .btn-submit {
        background: var(--success);
        color: white;
      }

      .btn-prev {
        background: #6c757d;
        color: white;
      }

      .audio-container {
        margin-top: 20px;
        display: none;
      }

      audio {
        width: 100%;
        margin-bottom: 15px;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
      }

      .completion-screen {
        text-align: center;
        padding: 40px 20px;
        display: none;
      }

      .completion-screen h2 {
        color: var(--success);
        margin-bottom: 15px;
      }

      .progress-container {
        margin: 20px 0;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
      }

      .progress-bar {
        height: 100%;
        background: var(--primary);
        border-radius: 3px;
        width: 0%;
        transition: width 0.3s;
      }

      /* Recording animation */
      .recording {
        position: relative;
      }

      .recording::after {
        content: "";
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border: 2px solid var(--accent);
        border-radius: 8px;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 0.2;
        }
        100% {
          opacity: 0.6;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Cambridge Flyers Speaking Test</h1>
        <p>Complete all 4 parts of the speaking test</p>
      </div>

      <div class="student-info">
        <input
          type="text"
          id="studentName"
          placeholder="Enter your name"
          required
        />
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Part 1: Find the Differences -->
      <div class="test-part active" id="part1">
        <div class="part-header">
          <div>
            <span class="part-number">Part 1</span>
            <h2 class="part-title">Find the Differences</h2>
          </div>
          <div class="timer" id="timer1">1-2 minutes</div>
        </div>

        <img
          src="images/part1.jpg"
          alt="Find differences"
          class="part-image"
        />
        <p class="task-description">
          Describe 4 differences between these pictures
        </p>

        <div class="controls">
          <button id="record1" class="btn btn-record">
            <span>●</span> Start Recording
          </button>
          <button id="stop1" class="btn btn-stop" disabled>
            <span>■</span> Stop
          </button>
        </div>

        <div id="audioContainer1" class="audio-container">
          <audio id="playback1" controls></audio>
          <button id="submit1" class="btn btn-submit">Submit Part 1</button>
        </div>
      </div>

      <!-- Part 2: Information Exchange -->
      <div class="test-part" id="part2">
        <div class="part-header">
          <div>
            <span class="part-number">Part 2</span>
            <h2 class="part-title">Information Exchange</h2>
          </div>
          <div class="timer" id="timer2">2 minutes</div>
        </div>

        <img
          src="images/part2.jpg"
          alt="Information exchange"
          class="part-image"
        />
        <p class="task-description">Answer questions about this information</p>

        <div class="controls">
          <button id="record2" class="btn btn-record">
            <span>●</span> Start Recording
          </button>
          <button id="stop2" class="btn btn-stop" disabled>
            <span>■</span> Stop
          </button>
        </div>

        <div id="audioContainer2" class="audio-container">
          <audio id="playback2" controls></audio>
          <div class="navigation">
            <button id="prev2" class="btn btn-prev">← Previous Part</button>
            <button id="submit2" class="btn btn-submit">Submit Part 2</button>
          </div>
        </div>
      </div>

      <!-- Part 3: Storytelling -->
      <div class="test-part" id="part3">
        <div class="part-header">
          <div>
            <span class="part-number">Part 3</span>
            <h2 class="part-title">Storytelling</h2>
          </div>
          <div class="timer" id="timer3">2-3 minutes</div>
        </div>

        <img
          src="images/part3.jpg"
          alt="Story pictures"
          class="part-image"
        />
        <p class="task-description">Tell the story shown in these pictures</p>

        <div class="controls">
          <button id="record3" class="btn btn-record">
            <span>●</span> Start Recording
          </button>
          <button id="stop3" class="btn btn-stop" disabled>
            <span>■</span> Stop
          </button>
        </div>

        <div id="audioContainer3" class="audio-container">
          <audio id="playback3" controls></audio>
          <div class="navigation">
            <button id="prev3" class="btn btn-prev">← Previous Part</button>
            <button id="submit3" class="btn btn-submit">Submit Part 3</button>
          </div>
        </div>
      </div>

      <!-- Part 4: Personal Questions -->
      <div class="test-part" id="part4">
        <div class="part-header">
          <div>
            <span class="part-number">Part 4</span>
            <h2 class="part-title">Personal Questions</h2>
          </div>
          <div class="timer" id="timer4">2 minutes</div>
        </div>

        <img
          src="images/part4.png"
          alt="Personal questions"
          class="part-image"
        />
        <p class="task-description">Answer questions about yourself</p>

        <div class="controls">
          <button id="record4" class="btn btn-record">
            <span>●</span> Start Recording
          </button>
          <button id="stop4" class="btn btn-stop" disabled>
            <span>■</span> Stop
          </button>
        </div>

        <div id="audioContainer4" class="audio-container">
          <audio id="playback4" controls></audio>
          <div class="navigation">
            <button id="prev4" class="btn btn-prev">← Previous Part</button>
            <button id="submit4" class="btn btn-submit">Complete Test</button>
          </div>
        </div>
      </div>

      <!-- Completion Screen -->
      <div class="completion-screen" id="completionScreen">
        <h2>Test Completed!</h2>
        <p>🎉Congratulations🎉</p>
        <button id="restartBtn" class="btn btn-submit" style="margin-top: 20px">
          Take Test Again
        </button>
      </div>
    </div>

    <script>
      // Test configuration
      const testParts = [
        { id: 1, time: 120 }, // Part 1: 2 minutes
        { id: 2, time: 120 }, // Part 2: 2 minutes
        { id: 3, time: 180 }, // Part 3: 3 minutes
        { id: 4, time: 120 }, // Part 4: 2 minutes
      ];

      // Global variables
      let currentPart = 0;
      let mediaRecorder;
      let audioChunks = [];
      let timers = [];

      // Initialize the test
      function initTest() {
        // Set up event listeners for all parts
        testParts.forEach((part, index) => {
          setupPart(part.id, index);
        });

        // Show first part
        showPart(0);
      }

      // Set up a test part
      function setupPart(partNumber, partIndex) {
        const recordBtn = document.getElementById(`record${partNumber}`);
        const stopBtn = document.getElementById(`stop${partNumber}`);
        const submitBtn = document.getElementById(`submit${partNumber}`);
        const prevBtn = document.getElementById(`prev${partNumber}`);
        const playback = document.getElementById(`playback${partNumber}`);
        const audioContainer = document.getElementById(
          `audioContainer${partNumber}`
        );

        // Record button click
        recordBtn.addEventListener("click", async () => {
          const studentName = document
            .getElementById("studentName")
            .value.trim();
          if (!studentName) {
            alert("Please enter your name first");
            return;
          }

          try {
            // Start recording
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
              playback.src = URL.createObjectURL(audioBlob);
              audioContainer.style.display = "block";
            };

            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            recordBtn.classList.add("recording");

            // Start timer
            startTimer(partNumber, testParts[partIndex].time);
          } catch (err) {
            alert("Error accessing microphone: " + err.message);
          }
        });

        // Stop button click
        stopBtn.addEventListener("click", () => {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
          recordBtn.disabled = false;
          stopBtn.disabled = true;
          recordBtn.classList.remove("recording");
          clearTimer(partNumber);
        });

        // Previous button click
        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            showPart(partIndex - 1);
          });
        }

        // Submit button click
        submitBtn.addEventListener("click", async () => {
          const studentName = document
            .getElementById("studentName")
            .value.trim();
          if (!studentName) {
            alert("Please enter your name");
            return;
          }

          if (audioChunks.length === 0) {
            alert("Please record your answer first");
            return;
          }

          // Prepare form data
          const formData = new FormData();
          formData.append(
            "audio",
            new Blob(audioChunks),
            `part${partNumber}.wav`
          );
          formData.append("studentName", studentName);
          formData.append("partNumber", partNumber);

          // Add part-specific data
          const partElement = document.getElementById(`part${partNumber}`);
          formData.append(
            "title",
            partElement.querySelector(".part-title").textContent
          );
          formData.append(
            "description",
            partElement.querySelector(".task-description").textContent
          );
          formData.append(
            "imageUrl",
            partElement.querySelector(".part-image").src.split("/").pop()
          );
          formData.append("timeLimit", testParts[partIndex].time);

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = "Submitting...";

            // Submit to server
            const response = await fetch("/api/submit-part", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();
            if (result.success) {
              // Move to next part or complete test
              if (partIndex < testParts.length - 1) {
                showPart(partIndex + 1);
              } else {
                // Test completed
                document.querySelectorAll(".test-part").forEach((part) => {
                  part.style.display = "none";
                });
                document.getElementById("completionScreen").style.display =
                  "block";
              }
            } else {
              alert("Error submitting: " + (result.error || "Unknown error"));
            }
          } catch (err) {
            alert("Network error: " + err.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent =
              partIndex === testParts.length - 1
                ? "Complete Test"
                : `Submit Part ${partNumber}`;
          }
        });
      }

      // Show a specific part
      function showPart(partIndex) {
        // Hide all parts
        document.querySelectorAll(".test-part").forEach((part) => {
          part.classList.remove("active");
        });

        // Show selected part
        document
          .getElementById(`part${testParts[partIndex].id}`)
          .classList.add("active");
        currentPart = partIndex;

        // Update progress bar
        updateProgress(((partIndex + 1) / testParts.length) * 100);
      }

      // Update progress bar
      function updateProgress(percent) {
        document.getElementById("progressBar").style.width = `${percent}%`;
      }

      // Start timer for a part
      function startTimer(partNumber, seconds) {
        clearTimer(partNumber);

        const timerElement = document.getElementById(`timer${partNumber}`);
        let timeLeft = seconds;

        timerElement.textContent = formatTime(timeLeft);

        timers[partNumber] = setInterval(() => {
          timeLeft--;
          timerElement.textContent = formatTime(timeLeft);

          if (timeLeft <= 0) {
            clearTimer(partNumber);
            document.getElementById(`stop${partNumber}`).click();
          }
        }, 1000);
      }

      // Clear timer
      function clearTimer(partNumber) {
        if (timers[partNumber]) {
          clearInterval(timers[partNumber]);
        }
      }

      // Format time as MM:SS
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? "0" : ""}${secs}`;
      }

      // Restart test
      document.getElementById("restartBtn").addEventListener("click", () => {
        location.reload();
      });

      // Initialize the test when page loads
      window.addEventListener("DOMContentLoaded", initTest);
    </script>
  </body>
</html>
